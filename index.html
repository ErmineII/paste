<!DOCTYPE html>
<html>
<head>
  <title>Paste</title>
  <meta charset="UTF-8" />
  <script type="text/javascript"> var langs = {}; </script>
  <script src="pako.min.js"></script>
  <script src="apl.js"></script>
  <script src="C.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="dark">
  <button id="saveB" style="height:2.6em;width:4.5em" onclick="save(true)">save</button>
  <button id="editB" style="height:2.6em;width:4.5em" onclick="md(0)">edit</button>
  <button id="viewB" style="height:2.6em;width:4.5em" onclick="md(2)">view</button>
  <button id="jscdB" style="height:2.6em;width:4.5em" onclick="md(1)">setup<br>JS</button>
  <button id="copyB" style="height:2.6em;width:4.5em" onclick="copy(main.value)">copy</button>
  <button id="colsB" style="height:2.6em;width:4.5em" onclick="changeTheme()">theme</button>
  <div style="position:absolute; top:3em; left:.5em; right:.5em; bottom:0">
    <textarea class="mainArea" id="main" spellcheck="false"></textarea>
    <textarea class="mainArea" id="jscd" spellcheck="false"></textarea>
    <pre      class="mainArea" id="genc" hidden>
    </pre>
  </div>
  
  <script type="text/javascript">
    var shortJS = {
      'APL': "lang('APL');font('APL386');",
      'dAPL': "lang('APL','dzaima');font('APL386');",
      'APL18': "lang('APL');font('APL386',18);",
      'dAPL18': "lang('APL','dzaima');font('APL386',18);",
      'C': "lang('C');",
      'JS': "lang('JS');",
      'Java': "lang('Java');",
    };
    
    
    var MODE = 0; // 0-edit; 1-JS edit; 2-view
    
    function md(mode) {
      MODE = mode;
      main.style.display = MODE==0? 'block' : 'none';
      jscd.style.display = MODE==1? 'block' : 'none';
      genc.style.display = MODE==2? 'block' : 'none';
      editB.disabled = MODE==0;
      jscdB.disabled = MODE==1;
      viewB.disabled = MODE==2;
      if (mode==0) main.focus();
      if (mode==2) generate();
    }
    
    
    function generate() {
      genc.innerText = main.value;
      genc.style="";
      eval(jscd.value);
    }
    function colorCode(str, cols, prefix) {
      let prev = cols[0];
      for (let i = 1; i < cols.length; i++) {
        let curr = cols[i];
        if (curr) {
          if (curr===prev) cols[i] = undefined;
          else prev = curr;
        }
      }
      let code = "";
      for (let i = 0; i < str.length; i++) {
        let ccol = cols[i];
        if (ccol) {
          if (code) code+= "</span>";
          code+= "<span class="+prefix+ccol+">"
        }
        code+= html(str[i]);
      }
      code+= "</span>";
      genc.innerHTML = code;
    }
    
    
    
    function lang(name, ...args) {
      langs[name](...args);
    }
    function font(name, sz) {
      genc.style.fontFamily = name;
      if (sz) genc.style.fontSize = sz+"px";
    }
    
    
    var theme = 0; // 0 - dark; 1 - light; 2 - black; 3 - default
    function changeTheme(nTheme = (theme+1) % 4) {
      theme = nTheme;
      localStorage.theme = nTheme;
      let colorScheme = theme==3? (window.matchMedia('(prefers-color-scheme: dark)').matches? 0 : 1) : theme;
      const themes = ["dark", "light", "black", "system"];
      document.body.classList.remove(...themes, "lt", "dt");
      document.body.classList.add(themes[colorScheme]);
      document.body.classList.add(colorScheme==1? "lt" : "dt");
      colsB.innerHTML = "theme<br>" + themes[theme];
    }
    changeTheme(localStorage.theme? +localStorage.theme : 0);
    
    
    function save(copyLink = false) {
      let b64 = "#0"+enc(main.value);
      if (jscd.value) {
        let ext = enc(jscd.value);
        for (let key in shortJS) {
          if (shortJS[key] == jscd.value) ext = key;
        }
        b64+= "#"+ext;
      }
      history.pushState({}, "", b64);
      if (copyLink) copy(location.href.replace("/#", "#"));
    }
    function enc(str = main.value) {
      let bytes = new TextEncoder("utf-8").encode(str);
      return arrToB64(deflate(bytes));
    }
    function dec(str) {
      try {
        return new TextDecoder("utf-8").decode(inflate(b64ToArr(str)));
      } catch (e) {
        return "failed to decode - full link not copied?";
      }
    }

    function arrToB64(arr) {
      var bytestr = "";
      arr.forEach(c => bytestr+= String.fromCharCode(c));
      return btoa(bytestr).replace(/\+/g, "@").replace(/=+/, "");
    }
    function b64ToArr(str) {
      return new Uint8Array([...atob(decodeURIComponent(str).replace(/@/g, "+"))].map(c=>c.charCodeAt()))
    }
    
    function deflate(arr) {
      return pako.deflateRaw(arr, {"level": 9});
    }
    function inflate(arr) {
      return pako.inflateRaw(arr);
    }
    
    function html(str) {
      return new Option(str).innerHTML.replace(/\n/g,'<br>');
    }
    function copy(str) {
      navigator.clipboard.writeText(str);
    }
    function load() {
      main.value = "";
      let hash = decodeURIComponent(location.hash.slice(1));
      let v = hash[0];
      hash = hash.slice(1); // remove version
      if (hash) {
        let parts = hash.split("#");
        main.value = parts[0]? dec(parts[0]) : "";
        jscd.value = "";
        if (parts.length >= 2) {
          let p2 = parts[1];
          if (shortJS[p2]) jscd.value = shortJS[p2];
          else jscd.value = dec(p2);
        }
        md(main.value? 2 : 0);
      } else md(0);
    }
    load();
    window.onhashchange=load;
    
    document.addEventListener("keydown", e => {
      let code = e.code;
      let ctrl = e.ctrlKey;
      let alt = e.altKey;
      if (alt) {
        if (code == 'KeyS') { saveB.click(); e.preventDefault(); viewB.click(); }
        if (code == 'KeyE') { editB.click(); e.preventDefault(); main.focus(); }
        if (code == 'KeyV') { viewB.click(); e.preventDefault(); }
        if (code == 'KeyJ') { jscdB.click(); e.preventDefault(); jscd.focus(); }
        if (code == 'KeyC') { copyB.click(); e.preventDefault(); }
        if (code == 'KeyT') { colsB.click(); e.preventDefault(); }
      }
      if (ctrl && code == 'KeyR') save(false);
      if (code == 'F5') save(false);
    });
  </script>
  
</body>
</html>