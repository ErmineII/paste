<!DOCTYPE html>
<html>
<head>
  <title>Paste</title>
  <meta charset="UTF-8" />
  <script type="text/javascript"> var langs = {}; </script>
  <script src="pako.min.js"></script>
  <script src="apl.js"></script>
  <script src="C.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <button id="saveB" style="height:2.6em;width:4em" onclick="save()">save</button>
  <button id="lockB" style="height:2.6em;width:4em" onclick="md(!ED, false)">view</button>
  <button id="jscdB" style="height:2.6em;width:4em" onclick="md(false, !JS)">JS</button>
  <button id="copyB" style="height:2.6em;width:4em" onclick="copy(main.value)">copy</button>
  <div style="position:absolute; top:3em; left:.5em; right:.5em; bottom:0">
    <textarea class="mainArea" id="main" spellcheck="false"></textarea>
    <textarea class="mainArea" id="jscd" spellcheck="false"></textarea>
    <pre      class="mainArea" id="genc" hidden>
    </pre>
  </div>
  
  <script type="text/javascript">
    var shortJS = {
      'APL': "lang('APL');font('APL386');",
      'dAPL': "lang('APL','dzaima');font('APL386');",
      'APL18': "lang('APL');font('APL386',18);",
      'dAPL18': "lang('APL','dzaima');font('APL386',18);",
      'C': "lang('C');",
      'JS': "lang('JS');",
      'Java': "lang('Java');",
    };
    
    
    var ED = false;
    var JS = false;
    function md(ed, js) {
      ED = ed;
      JS = js;
      let gen = !(ED || JS);
      main.style.display = ED ? 'block' : 'none';
      jscd.style.display = JS ? 'block' : 'none';
      genc.style.display = gen? 'block' : 'none';
      lockB.innerText=ED? "view" : "edit";
      jscdB.innerText=JS? "view" : "JS";
      if(gen) generate();
    }
    
    
    function generate() {
      genc.innerText = main.value;
      genc.style="";
      eval(jscd.value);
    }
    function colorCode(str, cols, prefix) {
      let prev = cols[0];
      for (let i = 1; i < cols.length; i++) {
        let curr = cols[i];
        if (curr) {
          if (curr===prev) cols[i] = undefined;
          else prev = curr;
        }
      }
      let code = "";
      for (let i = 0; i < str.length; i++) {
        let ccol = cols[i];
        if (ccol) {
          if (code) code+= "</span>";
          code+= "<span class="+prefix+ccol+">"
        }
        code+= html(str[i]);
      }
      code+= "</span>";
      genc.innerHTML = code;
    }
    
    
    
    function lang(name, ...args) {
      langs[name](...args);
    }
    function font(name, sz) {
      genc.style.fontFamily = name;
      if (sz) genc.style.fontSize = sz+"px";
    }
    
    
    
    function save() {
      let b64 = "#0"+enc(main.value);
      if (jscd.value) {
        let ext = enc(jscd.value);
        for (let key in shortJS) {
          if (shortJS[key] == jscd.value) ext = key;
        }
        b64+= "#"+ext;
      }
      history.pushState({}, "", b64);
      copy(location.href);
    }
    function enc(str = main.value) {
      let bytes = new TextEncoder("utf-8").encode(str);
      return arrToB64(deflate(bytes));
    }
    function dec(str) {
      return new TextDecoder("utf-8").decode(inflate(b64ToArr(str)));
    }

    function arrToB64(arr) {
      var bytestr = "";
      arr.forEach(c => bytestr+= String.fromCharCode(c));
      return btoa(bytestr).replace(/\+/g, "@").replace(/=+/, "");
    }
    function b64ToArr(str) {
      return new Uint8Array([...atob(decodeURIComponent(str).replace(/@/g, "+"))].map(c=>c.charCodeAt()))
    }
    
    function deflate(arr) {
      return pako.deflateRaw(arr, {"level": 9});
    }
    function inflate(arr) {
      return pako.inflateRaw(arr);
    }
    
    function html(str) {
      return new Option(str).innerHTML.replace(/\n/g,'<br>');
    }
    function copy(str) {
      navigator.clipboard.writeText(str);
    }
    function load() {
      main.value = "";
      let hash = decodeURIComponent(location.hash.slice(1));
      let v = hash[0];
      hash = hash.slice(1);
      if (hash) {
        let parts = hash.split("#");
        main.value = dec(parts[0]);
        jscd.value = "";
        if (parts.length >= 2) {
          let p2 = parts[1];
          if (shortJS[p2]) jscd.value = shortJS[p2];
          else jscd.value = dec(p2);
        }
        md(false, false);
      }
    }
    load();
    window.onhashchange=load;
  </script>
  
</body>
</html>